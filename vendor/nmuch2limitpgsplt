#!/usr/bin/env python3

import sys
import os

script = sys.argv[0]
args = sys.argv[1:]

def usage():
    return "%s FILE\n" % os.path.basename(script)

if len(args) != 1:
    sys.stderr.write(usage())
    sys.exit(1)

arg = args[0]

def err(text):
    sys.stderr.write("%s\n" % text)

def get_extra_chars_count(line_count):
    if line_count <= 1:
        return 5
    else:
        return 7

def nmuch2limitpgsplt(file):
    """
    notmuch search results (messages) splitter. Sends a page to stdout and the
    rest to stderr.

    Neomutt's limit pattern have to be 1023 characters long at most.
    """
    length = 0
    count = 0
    isend = False
    for item in file:
        line = item[:-1]
        if isend:
            err(line)
            continue
        if not line:
            isend = True
            err(line)
            continue
        count += 1
        extra_chars_count = get_extra_chars_count(count)
        if length + len(line) + extra_chars_count >= 1023:
            isend = True
            err(line)
            continue
        length += len(line) + extra_chars_count
        print(line)

if arg == "-":
    nmuch2limitpgsplt(sys.stdin) # '-' reads from standard input
    sys.exit(0)

file_to_paginate = open(arg)
nmuch2limitpgsplt(file_to_paginate)
