#!/usr/bin/env bash

# set -x
set -e

print_usage() {
	printf '\n%s\n' "$(basename $0) [-H] [-R]"
}

headers=""
redact=""
while getopts ":HR" opt
do
    case ${opt} in
        H)
            headers="true"
            ;;
        R)
            redact="--redact-headers"
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
            ;;
    esac
done
shift $((OPTIND - 1))

# Reads from stdin
if [[ ! ${#} -eq 0 ]]
then
	print_usage 1>&2
	exit 1
fi

redir=$(mktemp --suffix=_mutt)
tmpfile=$(mktemp --suffix=_mutt)

cat <&0 > "${redir}"

latin1(){
    file -i "${1}" | grep -q -i iso-8859-1
}

if latin1 "${redir}"
then
    iconvert -B -f latin1 -t utf-8 "${redir}"
fi

program="mail2txt"

if [[ -n "${headers}" ]]
then
    program="mail2headers"
fi

"${program}" ${redact} "${redir}" > "${tmpfile}"
dos2unix -f "${tmpfile}"
rm -f "${redir}"
text_mailcap "${tmpfile}"
