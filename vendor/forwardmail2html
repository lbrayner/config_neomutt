#!/usr/bin/env bash

# Email signatures in <blockquote> blocks
#
# No signaure: it's in pandoc's template (mail)

template="mail"

if [[ -n "${MUTT_CACHE}" ]] && [[ -f "${MUTT_CACHE}/pandoc_mail_template" ]]
then
    template="$(cat "${MUTT_CACHE}"/pandoc_mail_template)"
fi

# Cited email signatures: with line breaks
# Keywords: with line breaks
# Signatures: monospaced font and with line breaks
# Quit on finding last signature

<&0 sed -n -E \
    -e '/^-- $/,/^$/ s/.+/    &/' \
    -e '/^    -- $/,/^$/{H;/^    -- $/h;/^$/{g;p;T}}' -e t \
    -e '/> -- ?$/,/> ?$/ s/>( |( >)+)/&    /p' -e t \
    -e 'N; /.+\n(>( |( >)+))*[A-Z]\w*(-\w+)*( \w+)?: .*/ {s/\n|$/  &/gp;D}; P; D' \
    | pandoc --quiet --template=${template} \
    -f markdown_strict+pipe_tables+fenced_code_blocks -t html
